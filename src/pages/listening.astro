---
import Layout from "../layouts/MainLayout.astro";
import Music from "../components/Music.astro";
---

<Layout>
  <h1>listening</h1>
  <h2>my top 10 tracks of the last 4 weeks:</h2>
  <div id="music-info" class="grid grid-cols-3">
    <p>Loading top tracksâ€¦</p>
  </div>
  <Music />
</Layout>

<script>
  async function fetchTopTracks() {
    try {
      const res = await fetch("/.netlify/functions/spotify");
      const data = await res.json();

      const container = document.getElementById("music-info");

      if (!Array.isArray(data) || data.length === 0) {
        container.innerHTML = "<p>No top tracks found.</p>";
        return;
      }

      container.innerHTML = data
        .map(
          (track, index) => `
          <div id="topTrack" class="mr-[1rem] mb-[2rem]">
            <div class="text-lg font-bold mb-1">${index + 1}.</div>
            <img src="${track.albumImageUrl}" alt="Album cover" width="64" height="64" />
            <p><strong>${track.title}</strong> by ${track.artist}</p>
            <p>album: ${track.album}</p>
            <p><a href="${track.songUrl}" target="_blank">open in Spotify</a></p>
          </div>
        `
        )
        .join("");
    } catch (err) {
      document.getElementById("music-info").innerHTML =
        "<p>Error loading top tracks.</p>";
      console.error("Failed to load music:", err);
    }
  }

  fetchTopTracks();
</script>
